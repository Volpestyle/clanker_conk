stateDiagram-v2
    [*] --> IncomingMessage
    IncomingMessage --> AdmissionGate : shouldAttemptReplyDecision
    AdmissionGate --> NotAdmitted : false
    AdmissionGate --> Queued : true

    Queued --> QueueWait : coalesce/pacing/rate-limit wait
    QueueWait --> AdmissionRecheck
    AdmissionRecheck --> DroppedBeforeModel : false
    AdmissionRecheck --> ModelDecision : true

    ModelDecision --> Skipped : [SKIP]
    ModelDecision --> Skipped : empty reply (no media)
    ModelDecision --> Dispatch : sendable text/media

    Dispatch --> SentReply : shouldSendAsReply=true
    Dispatch --> SentMessage : shouldSendAsReply=false

    SentReply --> [*]
    SentMessage --> [*]
    Skipped --> ForceRetryCheck : forceRespond attempt
    ForceRetryCheck --> Queued : retry allowed
    ForceRetryCheck --> [*] : no retry
    DroppedBeforeModel --> [*]
    NotAdmitted --> [*]
