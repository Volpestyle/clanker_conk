sequenceDiagram
    autonumber
    participant User as Discord User
    participant Bot as ClankerBot
    participant Gate as replyAdmission
    participant Queue as queueGateway
    participant LLM as Reply LLM
    participant Discord as Discord API
    participant Store as Store

    User->>Bot: messageCreate(message)
    Bot->>Store: recordMessage(incoming)
    Bot->>Gate: getReplyAddressSignal(...)
    Bot->>Gate: shouldAttemptReplyDecision(...) [Stage A]
    alt admission denied
      Bot-->>Bot: do not enqueue reply
    else admission allowed
      Bot->>Queue: enqueueReplyJob(...)
      Queue->>Queue: coalesce burst + wait for pacing/rate limits
      Queue->>Gate: shouldAttemptReplyDecision(...) re-check
      alt re-check denied
        Queue-->>Queue: stop attempt
      else re-check allowed
        Queue->>LLM: generate reply (Stage B)
        alt model outputs [SKIP] or empty
          Queue->>Store: logAction(reply_skipped)
        else sendable reply
          alt sendAsReply
            Queue->>Discord: message.reply(payload)
            Queue->>Store: logAction(sent_reply)
          else sendAsMessage
            Queue->>Discord: channel.send(payload)
            Queue->>Store: logAction(sent_message)
          end
        end
      end
    end
