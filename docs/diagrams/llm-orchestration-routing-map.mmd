flowchart LR
    subgraph K[Routing Knobs]
      K1[llm.provider\nllm.model\nllm.temperature\nllm.maxOutputTokens]
      K2[replyFollowupLlm.enabled\nreplyFollowupLlm.provider/model]
      K3[memoryLlm.provider/model]
      K4[voice.generationLlm.provider/model]
      K5[voice.replyDecisionLlm.enabled\nprovider/model/maxAttempts]
      K6[activity.* / permissions.* / voice gating]
    end

    subgraph C[LLM Call Sites]
      C1[Primary text reply generation]
      C2[Text follow-up regeneration\nafter lookup directives]
      C3[Memory fact extraction]
      C4[Voice generation\nSTT + realtime brain]
      C5[Voice reply decision\nYES/NO classifier]
    end

    subgraph O[Outcomes]
      O1[Send message/reply/voice]
      O2[[SKIP or no-send]]
      O3[Log usage + cost\nllm_call / llm_error]
    end

    K1 --> C1
    K2 --> C2
    K3 --> C3
    K4 --> C4
    K5 --> C5
    K6 --> C1
    K6 --> C4
    K6 --> C5

    C1 --> O1
    C1 --> O2
    C2 --> O1
    C2 --> O2
    C3 --> O3
    C4 --> O1
    C4 --> O2
    C5 --> O1
    C5 --> O2

    C1 --> O3
    C2 --> O3
    C4 --> O3
    C5 --> O3
