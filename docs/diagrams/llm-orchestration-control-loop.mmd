flowchart TD
    A[Discord / Runtime Event] --> B[Load normalized settings]
    B --> C{Admission conditions pass?}

    C -->|No| D[Skip action\nlog reason]
    C -->|Yes| E[Assemble prompt package\nSystem + user + memory + recent context + contracts]

    E --> F[Route model call\nprovider + model + effort + token budget]
    F --> G[LLMService.generate]
    G --> H{Output contract valid?}

    H -->|No| I[Retry / fallback / skip\nlog contract violation or error]
    H -->|Yes| J[Execute action\nsend reply, message, reaction, voice, or directive]

    J --> K[Persist artifacts\nactions, usage, cost, messages]
    K --> L[Update runtime state\nrecent-bot windows, focused speaker, memory facts]
    L --> A

    D --> A
    I --> A
