flowchart TB
    subgraph Discord["Discord Voice Channel"]
        UA[User A Opus]
        UB[User B Opus]
        BOT[Bot Audio Out]
    end

    subgraph Audio["Audio Router"]
        DEC[Opus Decode]
        RES[Resample 48k→24k]
        BUF[Audio Buffer]
    end

    subgraph ASR["ASR Sessions (N per speaker)"]
        ASR1[ASR Session A]
        ASR2[ASR Session B]
        TTL[4s Idle TTL]
        TTL -->|"timeout"| CLOSE[Close Session]
        REC[User speaks] -->|"reconnect"| BUF
    end

    subgraph Orch["Orchestrator"]
        LABEL["Label: [Name/id]: text"]
        TURN[Turn Manager]
        GATE[shouldSpeak gate]
    end

    subgraph Brain["Brain Session (1)"]
        TEXT[Input Text + Image]
        TOOL[Tool Calls]
        AUDIO[Streaming Audio]
    end

    subgraph ScreenShare["Screen Share"]
        SSM[ScreenShareSessionManager<br/>Token + TTL + VC check]
        LINK[One-time /share/<token> link]
        PAGE[Companion page<br/>getDisplayMedia]
        INGEST[ingestFrameByToken]
    end

    LINK -->|"user opens"| PAGE
    SSM -.->|"generates"| LINK

    subgraph ToolRuntime["Tool Runtime"]
        MEM[memory_search<br/>memory_write]
        MUS[music_search<br/>music_queue_add<br/>music_play<br/>...]
        WEB[web_search]
        MCP[MCP Tools]
    end

    subgraph Output["Audio Output"]
        UP[Resample 24k→48k]
        OPUS[Encode Opus]
        DUCK[Ducking]
        PLAY[Play to Discord]
    end

    Discord --> Audio
    Audio --> ASR1
    Audio --> ASR2
    ASR1 -->|"transcript.delta/completed"| Orch
    ASR2 -->|"transcript.delta/completed"| Orch
    
    PAGE -->|"HTTP /frame"| INGEST
    INGEST -->|"validate + input_image"| Brain
    ATTACH -->|"input_image"| Brain
    
    Orch --> LABEL
    LABEL --> TEXT
    TEXT --> TURN
    TURN --> GATE
    GATE -->|"respond"| Brain
    Brain --> TOOL
    TOOL --> MEM
    TOOL --> MUS
    TOOL --> WEB
    TOOL --> MCP
    MEM -.->|"tool output"| Brain
    MUS -.->|"tool output"| Brain
    WEB -.->|"tool output"| Brain
    MCP -.->|"tool output"| Brain
    Brain --> AUDIO
    AUDIO --> Output
    Output --> Discord

    BARG[Human speaks during bot audio] -->|"barge-in"| STOP[Stop playback]
    STOP --> TRUNC[Truncate session]