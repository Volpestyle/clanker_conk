import React from "react";
import { SettingsSection } from "../SettingsSection";
import { rangeStyle } from "../../utils";
import { LlmProviderOptions } from "./LlmProviderOptions";

export function VoiceModeSettingsSection({
  id,
  form,
  set,
  showVoiceAdvanced,
  isVoiceAgentMode,
  isOpenAiRealtimeMode,
  isGeminiRealtimeMode,
  isSttPipelineMode,
  setVoiceReplyDecisionProvider,
  selectVoiceReplyDecisionPresetModel,
  voiceReplyDecisionModelOptions,
  selectedVoiceReplyDecisionPresetModel,
  setVoiceGenerationProvider,
  selectVoiceGenerationPresetModel,
  voiceGenerationModelOptions,
  selectedVoiceGenerationPresetModel,
  setVoiceThoughtEngineProvider,
  selectVoiceThoughtEnginePresetModel,
  voiceThoughtEngineModelOptions,
  selectedVoiceThoughtEnginePresetModel,
  xAiVoiceOptions,
  openAiRealtimeModelOptions,
  openAiRealtimeVoiceOptions,
  openAiTranscriptionModelOptions,
  geminiRealtimeModelOptions,
  sttTranscriptionModelOptions,
  sttTtsModelOptions,
  onResetVoiceReplyDecisionPrompts
}) {
  const isRealtimeMode = isVoiceAgentMode || isOpenAiRealtimeMode || isGeminiRealtimeMode;
  const realtimeReplyStrategy = String(form.voiceRealtimeReplyStrategy || "brain")
    .trim()
    .toLowerCase();
  const usesBrainGeneration = isSttPipelineMode || (isRealtimeMode && realtimeReplyStrategy === "brain");
  const classifierMergedWithGeneration =
    !form.voiceReplyDecisionLlmEnabled &&
    usesBrainGeneration;
  const classifierDisabledNativeRealtime =
    !form.voiceReplyDecisionLlmEnabled && isRealtimeMode && realtimeReplyStrategy === "native";
  return (
    <SettingsSection id={id} title="Voice Mode" active={form.voiceEnabled}>
      <div className="toggles">
        <label>
          <input type="checkbox" checked={form.voiceEnabled} onChange={set("voiceEnabled")} />
          Enable voice sessions
        </label>
      </div>

      {showVoiceAdvanced && (
        <>
          <label htmlFor="voice-mode">Voice runtime mode</label>
          <select id="voice-mode" value={form.voiceMode} onChange={set("voiceMode")}>
            <option value="voice_agent">Voice agent (xAI realtime low-latency)</option>
            <option value="openai_realtime">OpenAI realtime (low-latency)</option>
            <option value="gemini_realtime">Gemini realtime (audio + stream frames)</option>
            <option value="stt_pipeline">STT pipeline (reuse chat LLM + memory)</option>
          </select>

          {isRealtimeMode && (
            <>
              <label htmlFor="voice-realtime-reply-strategy">Realtime reply path</label>
              <select
                id="voice-realtime-reply-strategy"
                value={form.voiceRealtimeReplyStrategy}
                onChange={set("voiceRealtimeReplyStrategy")}
              >
                <option value="brain">Brain (our LLM reply generation)</option>
                <option value="native">Native realtime provider response</option>
              </select>
            </>
          )}

          <div className="toggles">
            <label>
              <input
                type="checkbox"
                checked={form.voiceAllowNsfwHumor}
                onChange={set("voiceAllowNsfwHumor")}
              />
              Voice: allow adult/NSFW humor (with safety limits)
            </label>
          </div>

          <div className="split">
            <div>
              <label htmlFor="voice-intent-threshold">Intent confidence threshold</label>
              <input
                id="voice-intent-threshold"
                type="number"
                min="0.4"
                max="0.99"
                step="0.01"
                value={form.voiceIntentConfidenceThreshold}
                onChange={set("voiceIntentConfidenceThreshold")}
              />
            </div>
            <div>
              <label htmlFor="voice-max-session-minutes">Max session minutes</label>
              <input
                id="voice-max-session-minutes"
                type="number"
                min="1"
                max="120"
                value={form.voiceMaxSessionMinutes}
                onChange={set("voiceMaxSessionMinutes")}
              />
            </div>
          </div>

          <div className="split">
            <div>
              <label htmlFor="voice-inactivity-seconds">Inactivity leave seconds</label>
              <input
                id="voice-inactivity-seconds"
                type="number"
                min="20"
                max="3600"
                value={form.voiceInactivityLeaveSeconds}
                onChange={set("voiceInactivityLeaveSeconds")}
              />
            </div>
            <div>
              <label htmlFor="voice-max-sessions-day">Max sessions/day</label>
              <input
                id="voice-max-sessions-day"
                type="number"
                min="0"
                max="120"
                value={form.voiceMaxSessionsPerDay}
                onChange={set("voiceMaxSessionsPerDay")}
              />
            </div>
          </div>

          <label htmlFor="voice-reply-eagerness">
            Voice reply eagerness (unaddressed turns): <strong>{form.voiceReplyEagerness}%</strong>
          </label>
          <input
            id="voice-reply-eagerness"
            type="range"
            min="0"
            max="100"
            step="1"
            value={form.voiceReplyEagerness}
            onChange={set("voiceReplyEagerness")}
            style={rangeStyle(form.voiceReplyEagerness)}
          />

          {usesBrainGeneration && (
            <>
              <h4>Brain LLM</h4>
              <p>Used for voice reply generation when the reply path is set to Brain.</p>
              <div className="split">
                <div>
                  <label htmlFor="voice-generation-provider">Provider</label>
                  <select
                    id="voice-generation-provider"
                    value={form.voiceGenerationLlmProvider}
                    onChange={setVoiceGenerationProvider}
                  >
                    <LlmProviderOptions />
                  </select>
                </div>
                <div>
                  <label htmlFor="voice-generation-model-preset">Model ID</label>
                  <select
                    id="voice-generation-model-preset"
                    value={selectedVoiceGenerationPresetModel}
                    onChange={selectVoiceGenerationPresetModel}
                  >
                    {voiceGenerationModelOptions.map((modelId) => (
                      <option key={modelId} value={modelId}>
                        {modelId}
                      </option>
                    ))}
                  </select>
                </div>
              </div>
            </>
          )}

          <h4>Voice Reply Decider</h4>
          <p>Controls when Clank should chime in during VC.</p>
          <div className="toggles">
            <label>
              <input
                type="checkbox"
                checked={form.voiceReplyDecisionLlmEnabled}
                onChange={set("voiceReplyDecisionLlmEnabled")}
              />
              Enable pre-reply classifier LLM step
            </label>
          </div>
          {classifierMergedWithGeneration && (
            <p>
              With classifier disabled, reply generation decides whether to speak by returning <code>[SKIP]</code>.
            </p>
          )}
          {classifierDisabledNativeRealtime && (
            <p>
              Native realtime mode has no Brain-generation step, so disabling the classifier keeps only
              deterministic fast-path admissions.
            </p>
          )}
          {form.voiceReplyDecisionLlmEnabled && (
            <>
              <div className="split">
                <div>
                  <label htmlFor="voice-reply-decision-provider">Provider</label>
                  <select
                    id="voice-reply-decision-provider"
                    value={form.voiceReplyDecisionLlmProvider}
                    onChange={setVoiceReplyDecisionProvider}
                  >
                    <LlmProviderOptions />
                  </select>
                </div>
                <div>
                  <label htmlFor="voice-reply-decision-model-preset">Model ID</label>
                  <select
                    id="voice-reply-decision-model-preset"
                    value={selectedVoiceReplyDecisionPresetModel}
                    onChange={selectVoiceReplyDecisionPresetModel}
                  >
                    {voiceReplyDecisionModelOptions.map((modelId) => (
                      <option key={modelId} value={modelId}>
                        {modelId}
                      </option>
                    ))}
                  </select>
                </div>
              </div>

              <details>
                <summary>Advanced classifier prompts/rules</summary>
                <p>
                  These are the YES/NO gate system prompts used before voice replies. Use <code>{"{{botName}}"}</code>{" "}
                  to reference the configured bot name.
                </p>

                <label htmlFor="voice-reply-decision-wake-variant-hint">Wake-variant rule hint</label>
                <textarea
                  id="voice-reply-decision-wake-variant-hint"
                  rows={4}
                  value={form.voiceReplyDecisionWakeVariantHint}
                  onChange={set("voiceReplyDecisionWakeVariantHint")}
                />

                <label htmlFor="voice-reply-decision-system-prompt-compact">System prompt (compact)</label>
                <textarea
                  id="voice-reply-decision-system-prompt-compact"
                  rows={8}
                  value={form.voiceReplyDecisionSystemPromptCompact}
                  onChange={set("voiceReplyDecisionSystemPromptCompact")}
                />

                <label htmlFor="voice-reply-decision-system-prompt-full">System prompt (full)</label>
                <textarea
                  id="voice-reply-decision-system-prompt-full"
                  rows={8}
                  value={form.voiceReplyDecisionSystemPromptFull}
                  onChange={set("voiceReplyDecisionSystemPromptFull")}
                />

                <label htmlFor="voice-reply-decision-system-prompt-strict">System prompt (strict retry)</label>
                <textarea
                  id="voice-reply-decision-system-prompt-strict"
                  rows={5}
                  value={form.voiceReplyDecisionSystemPromptStrict}
                  onChange={set("voiceReplyDecisionSystemPromptStrict")}
                />

                <button
                  type="button"
                  className="sm"
                  onClick={onResetVoiceReplyDecisionPrompts}
                >
                  Reset decider prompts
                </button>
              </details>
            </>
          )}

          <h4>Thought Engine</h4>
          <p>
            When VC is quiet, Clank can self-prompt a candidate thought and let the brain decide if it should be spoken.
          </p>
          <div className="toggles">
            <label>
              <input
                type="checkbox"
                checked={form.voiceThoughtEngineEnabled}
                onChange={set("voiceThoughtEngineEnabled")}
              />
              Enable silence thought loop
            </label>
          </div>
          {form.voiceThoughtEngineEnabled && (
            <>
              <div className="split">
                <div>
                  <label htmlFor="voice-thought-engine-provider">Provider</label>
                  <select
                    id="voice-thought-engine-provider"
                    value={form.voiceThoughtEngineProvider}
                    onChange={setVoiceThoughtEngineProvider}
                  >
                    <LlmProviderOptions />
                  </select>
                </div>
                <div>
                  <label htmlFor="voice-thought-engine-model-preset">Model ID</label>
                  <select
                    id="voice-thought-engine-model-preset"
                    value={selectedVoiceThoughtEnginePresetModel}
                    onChange={selectVoiceThoughtEnginePresetModel}
                  >
                    {voiceThoughtEngineModelOptions.map((modelId) => (
                      <option key={modelId} value={modelId}>
                        {modelId}
                      </option>
                    ))}
                  </select>
                </div>
              </div>

              <label htmlFor="voice-thought-eagerness">
                Thought eagerness: <strong>{form.voiceThoughtEngineEagerness}%</strong>
              </label>
              <input
                id="voice-thought-eagerness"
                type="range"
                min="0"
                max="100"
                step="1"
                value={form.voiceThoughtEngineEagerness}
                onChange={set("voiceThoughtEngineEagerness")}
                style={rangeStyle(form.voiceThoughtEngineEagerness)}
              />

              <div className="split">
                <div>
                  <label htmlFor="voice-thought-silence-seconds">Silence seconds before thought attempt</label>
                  <input
                    id="voice-thought-silence-seconds"
                    type="number"
                    min="8"
                    max="300"
                    value={form.voiceThoughtEngineMinSilenceSeconds}
                    onChange={set("voiceThoughtEngineMinSilenceSeconds")}
                  />
                </div>
                <div>
                  <label htmlFor="voice-thought-min-gap-seconds">Min seconds between thought attempts</label>
                  <input
                    id="voice-thought-min-gap-seconds"
                    type="number"
                    min="8"
                    max="600"
                    value={form.voiceThoughtEngineMinSecondsBetweenThoughts}
                    onChange={set("voiceThoughtEngineMinSecondsBetweenThoughts")}
                  />
                </div>
              </div>
            </>
          )}

          {isVoiceAgentMode && (
            <>
              <div className="split">
                <div>
                  <label htmlFor="voice-xai-voice">xAI voice</label>
                  <select id="voice-xai-voice" value={form.voiceXaiVoice} onChange={set("voiceXaiVoice")}>
                    {xAiVoiceOptions.map((voiceName) => (
                      <option key={voiceName} value={voiceName}>
                        {voiceName}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label htmlFor="voice-xai-region">xAI region</label>
                  <input id="voice-xai-region" type="text" value={form.voiceXaiRegion} onChange={set("voiceXaiRegion")} />
                </div>
              </div>

              <div className="split">
                <div>
                  <label htmlFor="voice-xai-audio-format">xAI audio format</label>
                  <input
                    id="voice-xai-audio-format"
                    type="text"
                    value={form.voiceXaiAudioFormat}
                    onChange={set("voiceXaiAudioFormat")}
                  />
                </div>
                <div>
                  <label htmlFor="voice-xai-sample-rate">xAI sample rate (Hz)</label>
                  <input
                    id="voice-xai-sample-rate"
                    type="number"
                    min="8000"
                    max="48000"
                    value={form.voiceXaiSampleRateHz}
                    onChange={set("voiceXaiSampleRateHz")}
                  />
                </div>
              </div>
            </>
          )}

          {isOpenAiRealtimeMode && (
            <>
              <div className="split">
                <div>
                  <label htmlFor="voice-openai-realtime-model">OpenAI realtime model</label>
                  <select
                    id="voice-openai-realtime-model"
                    value={form.voiceOpenAiRealtimeModel}
                    onChange={set("voiceOpenAiRealtimeModel")}
                  >
                    {openAiRealtimeModelOptions.map((modelId) => (
                      <option key={modelId} value={modelId}>
                        {modelId}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label htmlFor="voice-openai-realtime-voice">OpenAI realtime voice</label>
                  <select
                    id="voice-openai-realtime-voice"
                    value={form.voiceOpenAiRealtimeVoice}
                    onChange={set("voiceOpenAiRealtimeVoice")}
                  >
                    {openAiRealtimeVoiceOptions.map((voiceName) => (
                      <option key={voiceName} value={voiceName}>
                        {voiceName}
                      </option>
                    ))}
                  </select>
                </div>
              </div>

              <div className="split">
                <div>
                  <label htmlFor="voice-openai-realtime-input-format">OpenAI input audio format</label>
                  <input
                    id="voice-openai-realtime-input-format"
                    type="text"
                    value={form.voiceOpenAiRealtimeInputAudioFormat}
                    onChange={set("voiceOpenAiRealtimeInputAudioFormat")}
                  />
                </div>
                <div>
                  <label htmlFor="voice-openai-realtime-output-format">OpenAI output audio format</label>
                  <input
                    id="voice-openai-realtime-output-format"
                    type="text"
                    value={form.voiceOpenAiRealtimeOutputAudioFormat}
                    onChange={set("voiceOpenAiRealtimeOutputAudioFormat")}
                  />
                </div>
              </div>

              <div className="split">
                <div>
                  <label htmlFor="voice-openai-realtime-transcription-model">
                    OpenAI realtime input transcription model
                  </label>
                  <select
                    id="voice-openai-realtime-transcription-model"
                    value={form.voiceOpenAiRealtimeInputTranscriptionModel}
                    onChange={set("voiceOpenAiRealtimeInputTranscriptionModel")}
                  >
                    {openAiTranscriptionModelOptions.map((modelId) => (
                      <option key={modelId} value={modelId}>
                        {modelId}
                      </option>
                    ))}
                  </select>
                </div>
                <div />
              </div>
            </>
          )}

          {isGeminiRealtimeMode && (
            <>
              <div className="split">
                <div>
                  <label htmlFor="voice-gemini-realtime-model">Gemini realtime model</label>
                  <select
                    id="voice-gemini-realtime-model"
                    value={form.voiceGeminiRealtimeModel}
                    onChange={set("voiceGeminiRealtimeModel")}
                  >
                    {geminiRealtimeModelOptions.map((modelId) => (
                      <option key={modelId} value={modelId}>
                        {modelId}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label htmlFor="voice-gemini-realtime-voice">Gemini realtime voice</label>
                  <input
                    id="voice-gemini-realtime-voice"
                    type="text"
                    value={form.voiceGeminiRealtimeVoice}
                    onChange={set("voiceGeminiRealtimeVoice")}
                  />
                </div>
              </div>

              <div className="split">
                <div>
                  <label htmlFor="voice-gemini-realtime-api-base-url">Gemini API base URL</label>
                  <input
                    id="voice-gemini-realtime-api-base-url"
                    type="text"
                    value={form.voiceGeminiRealtimeApiBaseUrl}
                    onChange={set("voiceGeminiRealtimeApiBaseUrl")}
                  />
                </div>
                <div />
              </div>

              <div className="split">
                <div>
                  <label htmlFor="voice-gemini-realtime-input-sample-rate">Gemini input sample rate (Hz)</label>
                  <input
                    id="voice-gemini-realtime-input-sample-rate"
                    type="number"
                    min="8000"
                    max="48000"
                    value={form.voiceGeminiRealtimeInputSampleRateHz}
                    onChange={set("voiceGeminiRealtimeInputSampleRateHz")}
                  />
                </div>
                <div>
                  <label htmlFor="voice-gemini-realtime-output-sample-rate">Gemini output sample rate (Hz)</label>
                  <input
                    id="voice-gemini-realtime-output-sample-rate"
                    type="number"
                    min="8000"
                    max="48000"
                    value={form.voiceGeminiRealtimeOutputSampleRateHz}
                    onChange={set("voiceGeminiRealtimeOutputSampleRateHz")}
                  />
                </div>
              </div>
            </>
          )}

          {isSttPipelineMode && (
            <>
              <div className="split">
                <div>
                  <label htmlFor="voice-stt-transcribe-model">STT model</label>
                  <select
                    id="voice-stt-transcribe-model"
                    value={form.voiceSttTranscriptionModel}
                    onChange={set("voiceSttTranscriptionModel")}
                  >
                    {sttTranscriptionModelOptions.map((modelId) => (
                      <option key={modelId} value={modelId}>
                        {modelId}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label htmlFor="voice-stt-tts-model">TTS model</label>
                  <select
                    id="voice-stt-tts-model"
                    value={form.voiceSttTtsModel}
                    onChange={set("voiceSttTtsModel")}
                  >
                    {sttTtsModelOptions.map((modelId) => (
                      <option key={modelId} value={modelId}>
                        {modelId}
                      </option>
                    ))}
                  </select>
                </div>
              </div>

              <div className="split">
                <div>
                  <label htmlFor="voice-stt-tts-voice">TTS voice</label>
                  <input
                    id="voice-stt-tts-voice"
                    type="text"
                    value={form.voiceSttTtsVoice}
                    onChange={set("voiceSttTtsVoice")}
                  />
                </div>
                <div>
                  <label htmlFor="voice-stt-tts-speed">TTS speed</label>
                  <input
                    id="voice-stt-tts-speed"
                    type="number"
                    min="0.25"
                    max="2"
                    step="0.05"
                    value={form.voiceSttTtsSpeed}
                    onChange={set("voiceSttTtsSpeed")}
                  />
                </div>
              </div>
            </>
          )}

          <h4>Stream Watch</h4>
          <div className="toggles">
            <label>
              <input
                type="checkbox"
                checked={form.voiceStreamWatchEnabled}
                onChange={set("voiceStreamWatchEnabled")}
              />
              Enable stream frame ingest + commentary
            </label>
          </div>

          {form.voiceStreamWatchEnabled && (
            <div className="split">
              <div>
                <label htmlFor="voice-stream-watch-commentary-interval">
                  Min seconds between stream commentary turns
                </label>
                <input
                  id="voice-stream-watch-commentary-interval"
                  type="number"
                  min="3"
                  max="120"
                  value={form.voiceStreamWatchMinCommentaryIntervalSeconds}
                  onChange={set("voiceStreamWatchMinCommentaryIntervalSeconds")}
                />
              </div>
              <div>
                <label htmlFor="voice-stream-watch-max-fpm">Max ingested stream frames/min</label>
                <input
                  id="voice-stream-watch-max-fpm"
                  type="number"
                  min="6"
                  max="600"
                  value={form.voiceStreamWatchMaxFramesPerMinute}
                  onChange={set("voiceStreamWatchMaxFramesPerMinute")}
                />
              </div>
            </div>
          )}

          {form.voiceStreamWatchEnabled && (
            <div className="split">
              <div>
                <label htmlFor="voice-stream-watch-max-frame-bytes">Max stream frame bytes</label>
                <input
                  id="voice-stream-watch-max-frame-bytes"
                  type="number"
                  min="50000"
                  max="4000000"
                  value={form.voiceStreamWatchMaxFrameBytes}
                  onChange={set("voiceStreamWatchMaxFrameBytes")}
                />
              </div>
              <div />
            </div>
          )}

          <div className="toggles">
            <label>
              <input
                type="checkbox"
                checked={form.voiceSoundboardEnabled}
                onChange={set("voiceSoundboardEnabled")}
              />
              Enable voice soundboard director
            </label>
            {form.voiceSoundboardEnabled && (
              <label>
                <input
                  type="checkbox"
                  checked={form.voiceSoundboardAllowExternalSounds}
                  onChange={set("voiceSoundboardAllowExternalSounds")}
                />
                Allow external soundboard sounds
              </label>
            )}
          </div>

          {form.voiceSoundboardEnabled && (
            <>
              <label htmlFor="voice-sb-preferred">
                Sound refs (`sound_id` or `sound_id@source_guild_id`, one per line). Leave empty to auto-use guild sounds.
              </label>
              <textarea
                id="voice-sb-preferred"
                rows={3}
                value={form.voiceSoundboardPreferredSoundIds}
                onChange={set("voiceSoundboardPreferredSoundIds")}
              />
            </>
          )}

          <label htmlFor="voice-allowed-channels">Allowed voice channel IDs (optional)</label>
          <textarea
            id="voice-allowed-channels"
            rows={3}
            value={form.voiceAllowedChannelIds}
            onChange={set("voiceAllowedChannelIds")}
          />

          <label htmlFor="voice-blocked-channels">Blocked voice channel IDs</label>
          <textarea
            id="voice-blocked-channels"
            rows={3}
            value={form.voiceBlockedChannelIds}
            onChange={set("voiceBlockedChannelIds")}
          />

          <label htmlFor="voice-blocked-users">Blocked voice user IDs</label>
          <textarea
            id="voice-blocked-users"
            rows={3}
            value={form.voiceBlockedUserIds}
            onChange={set("voiceBlockedUserIds")}
          />
        </>
      )}
    </SettingsSection>
  );
}
